<app-navbar></app-navbar>

<ion-content [fullscreen]="true" class="reservar-page">
  
  <div class="page-container">
    <!-- Header -->
    <div class="header-section">
      <h1 class="page-title">
        Reserva tu <span class="gradient-text">Cita</span>
      </h1>
      <p class="page-description">
        Agenda tu cita en 3 simples pasos
      </p>
    </div>

    <!-- Progress Bar -->
    <div class="progress-section">
      <div class="progress-container">
        <div class="progress-step" 
             *ngFor="let stepNum of [1, 2, 3]; let i = index"
             [ngClass]="{'active': step >= stepNum, 'completed': step > stepNum}">
          <div class="step-circle">
            <ion-icon *ngIf="step > stepNum" name="checkmark-circle" class="check-icon"></ion-icon>
            <span *ngIf="step <= stepNum">{{ stepNum }}</span>
          </div>
          <div *ngIf="i < 2" class="step-connector" [ngClass]="{'active': step > stepNum}"></div>
        </div>
      </div>
    </div>

    <!-- Main Card -->
    <ion-card class="main-card">
      <ion-card-header>
        <ion-card-title class="card-title">{{ getStepTitle() }}</ion-card-title>
        <p class="card-description">{{ getStepDescription() }}</p>
      </ion-card-header>

      <ion-card-content>
        
        <!-- Step 1: Seleccionar Servicio -->
        <div *ngIf="step === 1" class="step-content">
          <div class="services-grid">
            <div *ngFor="let servicio of servicios" 
                 class="service-item"
                 [ngClass]="{'selected': formData.servicio === servicio.id}"
                 (click)="selectServicio(servicio.id)">
              
              <div class="service-content">
                <div class="service-info">
                  <h3 class="service-name">{{ servicio.nombre }}</h3>
                  <p class="service-description">{{ servicio.descripcion }}</p>
                  <div class="service-meta">
                    <span class="duration">
                      <ion-icon name="time-outline"></ion-icon>
                      {{ servicio.duracion }}
                    </span>
                  </div>
                </div>
                <div class="service-price">
                  ${{ formatPrice(servicio.precio) }}
                </div>
              </div>
            </div>
          </div>
          
          <ion-button 
            expand="block" 
            class="continue-button"
            [disabled]="!canContinueStep1()"
            (click)="handleNextStep()">
            <ion-icon name="arrow-forward" slot="end"></ion-icon>
            Continuar
          </ion-button>
        </div>

        <!-- Step 2: Seleccionar Barbero y Horario -->
        <div *ngIf="step === 2" class="step-content">
          
          <!-- Servicio Seleccionado -->
          <div class="section" *ngIf="getSelectedServicio()">
            <div class="selected-service-card">
              <div class="service-header">
                <h3 class="service-name">{{ getSelectedServicio()?.nombre }}</h3>
                <ion-button 
                  fill="clear" 
                  size="small"
                  class="change-service-button"
                  (click)="changeService()">
                  Cambiar Servicio
                </ion-button>
              </div>
              <div class="service-details">
                <span class="service-price">${{ formatPrice(getSelectedServicio()?.precio || 0) }}</span>
                <span class="service-duration">
                  <ion-icon name="time-outline"></ion-icon>
                  {{ getSelectedServicio()?.duracion }}
                </span>
              </div>
            </div>
          </div>
          
          <!-- Selección de Barbero -->
          <div class="section">
            <h3 class="section-title">
              Selecciona tu Barbero 
              <span class="barberos-count">({{ getFilteredBarberos().length }} disponibles)</span>
            </h3>
            <p class="section-subtitle">Barberos especializados en {{ getSelectedServicio()?.nombre }}</p>
            <div class="barbers-grid">
              <div *ngFor="let barbero of getFilteredBarberos()" 
                   class="barber-item"
                   [ngClass]="{'selected': formData.barbero === barbero.id}"
                   (click)="selectBarbero(barbero.id)">
                
                <div class="barber-info">
                  <h4 class="barber-name">{{ barbero.nombre }}</h4>
                  <p class="barber-specialty">Especialidad: {{ barbero.especialidad }}</p>
                  <p class="barber-experience">{{ barbero.experiencia }} de experiencia</p>
                </div>
                <div class="barber-rating">
                  <ion-icon name="star-outline" class="star-icon"></ion-icon>
                  <span>{{ barbero.rating }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Selección de Fecha y Hora -->
          <div class="section">
            <ion-grid>
              <ion-row>
                <ion-col size="12" sizeMd="6">
                  <ion-item class="form-item">
                    <ion-label position="stacked">Fecha</ion-label>
                    <ion-input 
                      type="date" 
                      [(ngModel)]="formData.fecha"
                      [min]="getCurrentDate()"
                      required>
                    </ion-input>
                  </ion-item>
                </ion-col>
                <ion-col size="12" sizeMd="6">
                  <ion-item class="form-item">
                    <ion-label position="stacked">Hora</ion-label>
                    <ion-select [(ngModel)]="formData.hora" placeholder="Seleccionar hora">
                      <ion-select-option *ngFor="let hora of horariosDisponibles" [value]="hora">
                        {{ hora }}
                      </ion-select-option>
                    </ion-select>
                  </ion-item>
                </ion-col>
              </ion-row>
            </ion-grid>
          </div>

          <div class="button-group">
            <ion-button 
              fill="outline" 
              class="back-button"
              (click)="handlePrevStep()">
              <ion-icon name="arrow-back" slot="start"></ion-icon>
              Volver
            </ion-button>
            <ion-button 
              class="continue-button"
              [disabled]="!canContinueStep2()"
              (click)="handleNextStep()">
              <ion-icon name="arrow-forward" slot="end"></ion-icon>
              Continuar
            </ion-button>
          </div>
        </div>

        <!-- Step 3: Datos Personales y Confirmación -->
        <div *ngIf="step === 3" class="step-content">
          
          <!-- Resumen de la Reserva -->
          <div class="summary-section">
            <h3 class="section-title">Resumen de tu Reserva</h3>
            <ion-grid>
              <ion-row>
                <ion-col size="12" sizeMd="6">
                  <div class="summary-item">
                    <strong>Servicio:</strong>
                    <p>{{ getSelectedServicio()?.nombre }}</p>
                  </div>
                </ion-col>
                <ion-col size="12" sizeMd="6">
                  <div class="summary-item">
                    <strong>Precio:</strong>
                    <p class="price-text">${{ formatPrice(getSelectedServicio()?.precio || 0) }}</p>
                  </div>
                </ion-col>
                <ion-col size="12" sizeMd="6">
                  <div class="summary-item">
                    <strong>Barbero:</strong>
                    <p>{{ getSelectedBarbero()?.nombre }}</p>
                  </div>
                </ion-col>
                <ion-col size="12" sizeMd="6">
                  <div class="summary-item">
                    <strong>Duración:</strong>
                    <p>{{ getSelectedServicio()?.duracion }}</p>
                  </div>
                </ion-col>
                <ion-col size="12" sizeMd="6">
                  <div class="summary-item">
                    <strong>Fecha:</strong>
                    <p>{{ formData.fecha }}</p>
                  </div>
                </ion-col>
                <ion-col size="12" sizeMd="6">
                  <div class="summary-item">
                    <strong>Hora:</strong>
                    <p>{{ formData.hora }}</p>
                  </div>
                </ion-col>
              </ion-row>
            </ion-grid>
          </div>

          <!-- Datos Personales -->
          <div class="section">
            <h3 class="section-title">Datos Personales</h3>
            <ion-grid>
              <ion-row>
                <ion-col size="12" sizeMd="6">
                  <ion-item class="form-item">
                    <ion-label position="stacked">Nombre Completo *</ion-label>
                    <ion-input 
                      [(ngModel)]="formData.nombre"
                      placeholder="Tu nombre completo"
                      required>
                    </ion-input>
                  </ion-item>
                </ion-col>
                <ion-col size="12" sizeMd="6">
                  <ion-item class="form-item">
                    <ion-label position="stacked">Teléfono *</ion-label>
                    <ion-input 
                      type="tel"
                      [(ngModel)]="formData.telefono"
                      placeholder="+56 9 1234 5678"
                      required>
                    </ion-input>
                  </ion-item>
                </ion-col>
              </ion-row>
              <ion-row>
                <ion-col size="12">
                  <ion-item class="form-item">
                    <ion-label position="stacked">Email *</ion-label>
                    <ion-input 
                      type="email"
                      [(ngModel)]="formData.email"
                      placeholder="tu@email.com"
                      required>
                    </ion-input>
                  </ion-item>
                </ion-col>
              </ion-row>
              <ion-row>
                <ion-col size="12">
                  <ion-item class="form-item">
                    <ion-label position="stacked">Notas adicionales (opcional)</ion-label>
                    <ion-textarea 
                      [(ngModel)]="formData.notas"
                      placeholder="Peticiones especiales, preferencias, etc."
                      [rows]="3">
                    </ion-textarea>
                  </ion-item>
                </ion-col>
              </ion-row>
            </ion-grid>
          </div>

          <div class="button-group">
            <ion-button 
              fill="outline" 
              class="back-button"
              (click)="handlePrevStep()">
              <ion-icon name="arrow-back" slot="start"></ion-icon>
              Volver
            </ion-button>
            <ion-button 
              class="submit-button"
              [disabled]="loading || !canSubmit()"
              (click)="handleSubmit()">
              <ion-spinner *ngIf="loading" name="crescent" slot="start"></ion-spinner>
              <span *ngIf="!loading">Confirmar Reserva</span>
              <span *ngIf="loading">Confirmando...</span>
            </ion-button>
          </div>
        </div>

      </ion-card-content>
    </ion-card>
  </div>

  <!-- Toast -->
  <ion-toast
    [isOpen]="showToast"
    [message]="toastMessage"
    [duration]="3000"
    (didDismiss)="showToast = false"
    color="success"
    position="top">
  </ion-toast>

</ion-content>
