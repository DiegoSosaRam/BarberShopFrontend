<app-navbar></app-navbar>

<ion-content [fullscreen]="true" class="reservar-page">
  
  <div class="page-container">
    <!-- Header -->
    <div class="header-section">
      <h1 class="page-title">
        Reserva tu <span class="gradient-text">Cita</span>
      </h1>
      <p class="page-description">
        Agenda tu cita en 3 simples pasos
      </p>
    </div>

    <!-- Progress Bar -->
    <div class="progress-section">
      <div class="progress-container">
        @for (stepNum of [1, 2, 3]; track stepNum; let i = $index) {
          <div class="progress-step" 
               [ngClass]="{'active': step >= stepNum, 'completed': step > stepNum}">
            <div class="step-circle">
              @if (step > stepNum) {
                <ion-icon name="checkmark-circle" class="check-icon"></ion-icon>
              }
              @if (step <= stepNum) {
                <span>{{ stepNum }}</span>
              }
            </div>
            @if (i < 2) {
              <div class="step-connector" [ngClass]="{'active': step > stepNum}"></div>
            }
          </div>
        }
      </div>
    </div>

    <!-- Main Card -->
    <ion-card class="main-card">
      <ion-card-header>
        <ion-card-title class="card-title">{{ getStepTitle() }}</ion-card-title>
        <p class="card-description">{{ getStepDescription() }}</p>
      </ion-card-header>

      <ion-card-content>
        
        <!-- Step 1: Seleccionar Servicio -->
        @if (step === 1) {
          <div class="step-content">
            <div class="services-grid">
              @for (servicio of servicios; track servicio.id_servicio) {
                <div class="service-item"
                     [ngClass]="{'selected': formData.servicio === servicio.id_servicio.toString()}"
                     (click)="selectServicio(servicio.id_servicio.toString())">
              
              <div class="service-content">
                <div class="service-info">
                  <h3 class="service-name">{{ servicio.nombre_servicio }}</h3>
                  <p class="service-description">{{ servicio.description }}</p>
                  <div class="service-meta">
                    <span class="duration">
                      <ion-icon name="time-outline"></ion-icon>
                      {{ servicio.duracion_min }} min
                    </span>
                  </div>
                </div>
                <div class="service-price">
                  ${{ formatPrice(servicio.precio_BarbServ) }}
                </div>
              </div>
                </div>
              }
            </div>
            
            <ion-button 
              expand="block" 
              class="continue-button"
              [disabled]="!canContinueStep1()"
              (click)="handleNextStep()">
              <ion-icon name="arrow-forward" slot="end"></ion-icon>
              Continuar
            </ion-button>
          </div>
        }        <!-- Step 2: Seleccionar Barbero y Horario -->
        @if (step === 2) {
          <div class="step-content">
            
            <!-- Servicio Seleccionado -->
            @if (getSelectedServicio()) {
              <div class="section">
                <div class="selected-service-card">
              <div class="service-header">
                <h3 class="service-name">{{ getSelectedServicio()?.nombre_servicio }}</h3>
                <ion-button 
                  fill="clear" 
                  size="small"
                  class="change-service-button"
                  (click)="changeService()">
                  Cambiar Servicio
                </ion-button>
              </div>
              <div class="service-details">
                <span class="service-price">${{ formatPrice(getSelectedServicio()?.precio_BarbServ || 0) }}</span>
                <span class="service-duration">
                  <ion-icon name="time-outline"></ion-icon>
                  {{ getSelectedServicio()?.duracion_min }} min
                </span>
              </div>
            </div>
          </div>
          
          <!-- Selección de Barbero -->
          <div class="section">
            <h3 class="section-title">
              Selecciona tu Barbero 
              <span class="barberos-count">({{ getDisplayedBarberos().length }} disponibles)</span>
            </h3>
            <p class="section-subtitle">Barberos especializados en {{ getSelectedServicio()?.nombre_servicio }}</p>
            
            <!-- Buscador de Barberos -->
            <div class="search-section">
              <ion-item class="search-item">
                <ion-label position="stacked">Buscar Barbero</ion-label>
                <ion-input 
                  [(ngModel)]="searchTerm"
                  placeholder="Buscar por nombre, especialidad o experiencia..."
                  (ionInput)="onSearchTermChange()"
                  clearInput="true">
                  <ion-icon name="search-outline" slot="start"></ion-icon>
                </ion-input>
              </ion-item>
              
              @if (searchTerm) {
                <div class="search-info">
                  <p class="search-results">
                    Mostrando {{ getDisplayedBarberos().length }} de {{ getFilteredBarberos().length }} barberos
                    @if (searchTerm) {
                      para "{{ searchTerm }}"
                    }
                  </p>
                  <ion-button 
                    fill="clear" 
                    size="small" 
                    (click)="clearSearch()"
                    class="clear-search-btn">
                    <ion-icon name="close-circle-outline" slot="start"></ion-icon>
                    Limpiar búsqueda
                  </ion-button>
                </div>
              }
            </div>
            
            <div class="barbers-grid">
              @for (barbero of getDisplayedBarberos(); track barbero.id_barbero) {
                <div class="barber-item"
                     [ngClass]="{'selected': formData.barbero === barbero.id_barbero.toString()}"
                     (click)="selectBarbero(barbero.id_barbero.toString())">
                
                <div class="barber-info">
                  <h4 class="barber-name">{{ barbero.nombre_barbero }}</h4>
                  <p class="barber-specialty">Especialidad: {{ barbero.especialidades }}</p>
                  <p class="barber-experience">{{ barbero.anios_experiencia }} años de experiencia</p>
                </div>
                  <div class="barber-rating">
                    <ion-icon name="star" class="star-icon"></ion-icon>
                    <span>{{ barbero.calificacion }}</span>
                  </div>
                </div>
              }
            </div>
          </div>

          <!-- Selección de Fecha y Hora -->
          <div class="section">
            <ion-grid>
              <ion-row>
                <ion-col size="12" sizeMd="6">
                  <ion-item class="form-item">
                    <ion-label position="stacked">Fecha</ion-label>
                    <ion-input 
                      type="date" 
                      [(ngModel)]="formData.fecha"
                      [min]="getCurrentDate()"
                      required>
                    </ion-input>
                  </ion-item>
                </ion-col>
                <ion-col size="12" sizeMd="6">
                  <ion-item class="form-item">
                    <ion-label position="stacked">Hora</ion-label>
                    <ion-select [(ngModel)]="formData.hora" placeholder="Seleccionar hora">
                      @for (hora of horariosDisponibles; track hora) {
                        <ion-select-option [value]="hora">
                          {{ hora }}
                        </ion-select-option>
                      }
                    </ion-select>
                  </ion-item>
                </ion-col>
              </ion-row>
            </ion-grid>
              </div>
            }
          </div>

          <div class="button-group">
            <ion-button 
              fill="outline" 
              class="back-button"
              (click)="handlePrevStep()">
              <ion-icon name="arrow-back" slot="start"></ion-icon>
              Volver
            </ion-button>
            <ion-button 
              class="continue-button"
              [disabled]="!canContinueStep2()"
              (click)="handleNextStep()">
              <ion-icon name="arrow-forward" slot="end"></ion-icon>
              Continuar
            </ion-button>
          </div>
        }

        <!-- Step 3: Datos Personales y Confirmación -->
        @if (step === 3) {
          <div class="step-content">
          
          <!-- Resumen de la Reserva -->
          <div class="summary-section">
            <h3 class="section-title">Resumen de tu Reserva</h3>
            <ion-grid>
              <ion-row>
                <ion-col size="12" sizeMd="6">
                  <div class="summary-item">
                    <strong>Servicio:</strong>
                    <p>{{ getSelectedServicio()?.nombre_servicio }}</p>
                  </div>
                </ion-col>
                <ion-col size="12" sizeMd="6">
                  <div class="summary-item">
                    <strong>Precio:</strong>
                    <p class="price-text">${{ formatPrice(getSelectedServicio()?.precio_BarbServ || 0) }}</p>
                  </div>
                </ion-col>
                <ion-col size="12" sizeMd="6">
                  <div class="summary-item">
                    <strong>Barbero:</strong>
                    <p>{{ getSelectedBarbero()?.nombre_barbero }}</p>
                  </div>
                </ion-col>
                <ion-col size="12" sizeMd="6">
                  <div class="summary-item">
                    <strong>Duración:</strong>
                    <p>{{ getSelectedServicio()?.duracion_min }} min</p>
                  </div>
                </ion-col>
                <ion-col size="12" sizeMd="6">
                  <div class="summary-item">
                    <strong>Fecha:</strong>
                    <p>{{ formData.fecha }}</p>
                  </div>
                </ion-col>
                <ion-col size="12" sizeMd="6">
                  <div class="summary-item">
                    <strong>Hora:</strong>
                    <p>{{ formData.hora }}</p>
                  </div>
                </ion-col>
              </ion-row>
            </ion-grid>
          </div>

          <!-- Datos Personales -->
          <div class="section">
            
            <!-- Si el usuario NO está logueado -->
            @if (!isUserLoggedIn) {
              <div class="auth-section">
              <h3 class="section-title">Para continuar, necesitas iniciar sesión</h3>
              <p class="auth-description">
                Inicia sesión o crea una cuenta para completar tu reserva. 
                Tus datos se guardarán automáticamente para futuras reservas.
              </p>
              
              <div class="auth-buttons">
                <ion-button 
                  expand="block" 
                  (click)="goToLogin()" 
                  class="auth-button login-btn">
                  <ion-icon name="person-outline" slot="start"></ion-icon>
                  Iniciar Sesión
                </ion-button>
                
                <ion-button 
                  expand="block" 
                  fill="outline" 
                  (click)="goToRegister()" 
                  class="auth-button register-btn">
                  <ion-icon name="person-add-outline" slot="start"></ion-icon>
                  Crear Cuenta
                </ion-button>
                
                <div class="guest-option">
                  <p class="guest-text">¿O prefieres continuar sin crear una cuenta?</p>
                  <ion-button 
                    fill="clear" 
                    (click)="continueAsGuest()" 
                    class="guest-button">
                    Continuar como invitado
                  </ion-button>
                </div>
              </div>
              </div>
            }
            
            <!-- Si el usuario SÍ está logueado O continúa como invitado -->
            @if (isUserLoggedIn || showGuestForm) {
              <div class="user-logged-section">
                @if (isUserLoggedIn) {
                  <h3 class="section-title">
                    Datos Personales 
                    <span class="logged-badge">
                      <ion-icon name="checkmark-circle-outline"></ion-icon>
                      Logueado como {{ currentUser?.nombre }}
                    </span>
                  </h3>
                }
                @if (!isUserLoggedIn && showGuestForm) {
                  <h3 class="section-title">
                    Datos Personales
                  </h3>
                }
              
              <!-- Formulario de datos -->
              <ion-grid>
                <ion-row>
                  <ion-col size="12" sizeMd="6">
                    <ion-item class="form-item">
                      <ion-label position="stacked">Nombre Completo *</ion-label>
                      <ion-input 
                        [(ngModel)]="formData.nombre"
                        placeholder="Tu nombre completo"
                        required>
                      </ion-input>
                    </ion-item>
                  </ion-col>
                  <ion-col size="12" sizeMd="6">
                    <ion-item class="form-item">
                      <ion-label position="stacked">Teléfono *</ion-label>
                      <ion-input 
                        type="tel"
                        [(ngModel)]="formData.telefono"
                        placeholder="+56 9 1234 5678"
                        required>
                      </ion-input>
                    </ion-item>
                  </ion-col>
                </ion-row>
                <ion-row>
                  <ion-col size="12">
                    <ion-item class="form-item">
                      <ion-label position="stacked">Email *</ion-label>
                      <ion-input 
                        type="email"
                        [(ngModel)]="formData.email"
                        placeholder="tu@email.com"
                        required>
                      </ion-input>
                    </ion-item>
                  </ion-col>
                </ion-row>
                <ion-row>
                  <ion-col size="12">
                    <ion-item class="form-item">
                      <ion-label position="stacked">Notas adicionales (opcional)</ion-label>
                      <ion-textarea 
                        [(ngModel)]="formData.notas"
                        placeholder="Peticiones especiales, preferencias, etc."
                        [rows]="3">
                      </ion-textarea>
                    </ion-item>
                  </ion-col>
                </ion-row>
              </ion-grid>
              </div>
            }
          </div>

          <div class="button-group">
            <ion-button 
              fill="outline" 
              class="back-button"
              (click)="handlePrevStep()">
              <ion-icon name="arrow-back" slot="start"></ion-icon>
              Volver
            </ion-button>
            <ion-button 
              class="submit-button"
              [disabled]="loading || !canSubmit()"
              (click)="handleSubmit()">
              @if (loading) {
                <ion-spinner name="crescent" slot="start"></ion-spinner>
              }
              @if (!loading) {
                <span>Confirmar Reserva</span>
              }
              @if (loading) {
                <span>Confirmando...</span>
              }
            </ion-button>
          </div>
          </div>
        }

      </ion-card-content>
    </ion-card>
  </div>

  <!-- Toast -->
  <ion-toast
    [isOpen]="showToast"
    [message]="toastMessage"
    [duration]="3000"
    (didDismiss)="showToast = false"
    color="success"
    position="top">
  </ion-toast>

</ion-content>
